#+Title: Badlock Implementation Tutorial
#+SETUPFILE: ~/src/org-html-themes/setup/theme-readtheorg.setup

[[file:../media/badlock.png]]

I needed to be able to install an older vulnerable version of samba so I use my
yum client repository policy to ensure my hosts are pointing to their release
specific sources.

I started with the [[http://cfengine.vagrant-baseboxes.s3.amazonaws.com/enterprise-getting-started/CFEngine_Enterprise_vagrant_quickstart-3.7.3-1.tar.gz][CFEngine Enterprise 3.7.3]] [[https://docs.cfengine.com/docs/3.7/guide-installation-and-configuration-general-installation-installation-enterprise-vagrant.html][vagrant environment]].

* Download the environment:

#+BEGIN_SRC sh
cd /tmp
wget http://cfengine.vagrant-baseboxes.s3.amazonaws.com/enterprise-getting-started/CFEngine_Enterprise_vagrant_quickstart-3.7.3-1.tar.gz
tar zxvf CFEngine_Enterprise_vagrant_quickstart-3.7.3-1.tar.gz
mv CFEngine_Enterprise_vagrant_quickstart-3.7.3-1 badlock_demo
cd badlock_demo
#+END_SRC

* Prepare the environment

#+BEGIN_SRC sh
vagrant up
vagrant ssh hub
sudo -i
#+END_SRC

* Install [[https://github.com/nickanderson/cfengine-yum][=nickanderson/cfengine-yum=]]

Install the yum policy We need to manage our repository definitions so that we
can be sure to get a vulnerable package installed, and leverage the current
updates available for remediation.

#+BEGIN_SRC sh
cd /tmp
git clone https://github.com/nickanderson/cfengine-yum
cd cfengine-yum
make install
#+END_SRC

* Install [[https://github.com/nickanderson/cfengine-CVE-2016-2118][=nickanderson/cfengine-CVE-2016-2118=]]

Now we need to integrate the Badlock inventory and remediation policy so that we
can know which systms are affected, so that remediation can be arrange ed.

#+BEGIN_SRC sh
cd /tmp
git clone https://github.com/nickanderson/cfengine-CVE-2016-2118
cd cfengine-CVE-2016-2118
make install
#+END_SRC

* Integrate the policies
Create an augments file:
  - Include the CVE policy
  - Include the yum policy
  - Include yum repo definitions containing public repo definitions that can be
    controlled with the =public_distro_repo_definitions_user_version_specific=
    and =public_distro_repo_definitions_use_latest=
  - Define the =enable_yum_inventory= class to get yum inventory.
  - Include the =demo_badlock.cf= policy to get some hosts installed with a
    vulnerable version of samba.

#+BEGIN_SRC sh
echo '
  {
      "inputs": [
          "services/cfengine-CVE-2016-2118/main.cf",
          "services/cfengine-CVE-2016-2118/extras/demo_badlock.cf",
          "services/cfengine-yum/def.cf",
          "services/cfengine-yum/examples/distro_mirrors.cf"
      ],

      "classes": {
          "services_autorun": [ "any" ],
          "enable_yum_inventory": [ "any" ],
          "public_distro_repo_definitions_use_version_specific": [ "any" ]
      }
  }
' > /var/cfengine/masterfiles/def.json
#+END_SRC

Go take a brisk walk, grab a cup or glass of your favorite beverage.

* Review vulnerable hosts

After ~15 minutes we should see the new =Vulnerable CVE(s)= attribute in Mission Portals
Inventory reporting interface.

[[file:../media/vulnerable_cves_inventory_attribute.png]]

[[file:../media/inventory_report_vulnerable_cves.png]]

We can then chart the attribute and see the distribution of hosts that are
affect.

[[file:../media/inventory_report_vulnerable_cves_chart.png]]

Now that we have the inventory, we can create a dashboard widget and alert to
make vulnerable hosts more vi sable or even [[https://cfengine.com/learn/ticketing-system-integration-jira/][integrate it with a custom action]].

[[file:../media/define_alert.png]]

[[file:../media/alert_status_vulnerable_hosts.png]]

*** Remediate vulnerable hosts

Finally, now that we have a good understanding of the current state, we can
adjust the policy to allow for automatic remediation. We need to do two things,
first we need to define the class =public_distro_repo_definitions_use_latest= so
that we can get access to repositories containing the latest versions of samba
that are not vulnerable, and we need to define the class
=remediate_CVE_2016_2118= to enable the automatic upgrade of samba to the latest
version on affected hosts.

#+BEGIN_SRC sh
echo '
  {
      "inputs": [
          "services/cfengine-CVE-2016-2118/main.cf",
          "services/cfengine-CVE-2016-2118/extras/demo_badlock.cf",
          "services/cfengine-yum/def.cf",
          "services/cfengine-yum/examples/distro_mirrors.cf"
      ],

      "classes": {
          "services_autorun": [ "any" ],
          "remediate_CVE_2016_2118": [ "any" ],
          "enable_yum_inventory": [ "any" ],
          "public_distro_repo_definitions_use_latest": [ "any" ]
      }
  }
' > /var/cfengine/masterfiles/def.json
#+END_SRC

Make the changes to def.json and wait for the hosts to automatically remediate
themselves.
